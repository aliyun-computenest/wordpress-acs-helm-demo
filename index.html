<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="计算巢是阿里云开放给企业应用服务商的服务管理平台。服务商能够在计算巢上发布私有化部署服务，为其客户提供云上软件一键部署的能力；同时也支持全托管模式的服务，赋能服务商托管其客户资源。">
  <title>服务模板说明文档 - Aliyun 计算巢 x wordpress-acs-helm-demo</title>

  <link rel="shortcut icon" href="img/favicon.ico">

  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
  <link rel="stylesheet" href="css/theme.css">
  

  

  
  

  
    <script src="search/main.js"></script>
  

  

  <script src="js/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>

<body>
  <div class="container">
    <div class="nav">
      <div class="nav-inner">
        <div class="logo">
          <img src="./img/logo-2x.png">
        </div>
        <div class="nav-list">
          <ul>
          
              <li><a href="#_1">服务模板说明文档</a></li>
              
                  <li><a href="#_2">服务说明</a></li>
                  
              
                  <li><a href="#_3">服务架构</a></li>
                  
              
                  <li><a href="#_4">服务构建计费说明</a></li>
                  
              
                  <li><a href="#ram">RAM账号所需权限</a></li>
                  
              
                  <li><a href="#_5">服务实例计费说明</a></li>
                  
              
                  <li><a href="#_6">服务实例部署流程</a></li>
                  
                      <li class="li-h3"><a href="#_7">部署参数说明</a></li>
                  
              
                  <li><a href="#_8">服务详细说明</a></li>
                  
                      <li class="li-h3"><a href="#_9">部署物</a></li>
                  
                      <li class="li-h3"><a href="#_10">模版文件</a></li>
                  
              
          
          </ul>
        </div>
      </div>
    </div>
    <div class="content theme-github">
      
      <div class="content-inner">        
        
        <h1 id="_1">服务模板说明文档</h1>
<h2 id="_2">服务说明</h2>
<p>本文介绍wordpress服务acs+helm版快速上手流程，本示例对应的Git仓库地址：<a href="https://github.com/aliyun-computenest/wordpress-acs-helm-demo">wordpress-acs-helm-demo</a>。</p>
<p>本示例会自动的构建计算巢服务，具体的服务构建流程为:</p>
<ol>
<li>将wordpress对应的helm chart压缩文件，上传到计算巢仓库中，生成计算巢helm部署物。</li>
<li>通过ros模版创建计算巢服务，计算巢服务需要关联helm部署物。</li>
</ol>
<p>创建过程大约持续1分钟，当服务变成待提交后构建成功。</p>
<h2 id="_3">服务架构</h2>
<p>本部署架构为acs集群部署，将helm chart文件通过WordpressComputenestHelmApplication资源部署到acs集群中，通过service绑定的loadBalancer的公网ip进行访问，这个loadbalancer的创建由ack集群自动完成, 在本例中，service提供的对外端口为80，和容器对外提供的端口相同。</p>
<p><img alt="img.png" src="architecture.png" /></p>
<h2 id="_4">服务构建计费说明</h2>
<p>测试本服务构建无需任何费用，创建服务实例涉及的费用参考服务实例计费说明。</p>
<h2 id="ram">RAM账号所需权限</h2>
<p>本服务需要对ACS、ECS、VPC等资源进行访问和创建操作，若您使用RAM用户创建服务实例，需要在创建服务实例前，对使用的RAM用户的账号添加相应资源的权限。添加RAM权限的详细操作，请参见<a href="https://help.aliyun.com/document_detail/121945.html">为RAM用户授权</a>。所需权限如下表所示：</p>
<table>
<thead>
<tr>
<th>权限策略名称</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>AliyunCSFullAccess</td>
<td>管理容器服务(CS)的权限</td>
</tr>
<tr>
<td>AliyunECSFullAccess</td>
<td>管理云服务器服务（ECS）的权限</td>
</tr>
<tr>
<td>AliyunVPCFullAccess</td>
<td>管理专有网络（VPC）的权限</td>
</tr>
<tr>
<td>AliyunROSFullAccess</td>
<td>管理资源编排服务（ROS）的权限</td>
</tr>
<tr>
<td>AliyunComputeNestUserFullAccess</td>
<td>管理计算巢服务（ComputeNest）的用户侧权限</td>
</tr>
<tr>
<td>AliyunComputeNestSupplierFullAccess</td>
<td>管理计算巢服务（ComputeNest）的服务商侧权限</td>
</tr>
</tbody>
</table>
<h2 id="_5">服务实例计费说明</h2>
<p>测试本服务在计算巢上的费用主要涉及：</p>
<ul>
<li>acs集群部署pod所需vCPU、内存、磁盘费用</li>
<li>公网带宽</li>
</ul>
<p>计费方式包括：</p>
<ul>
<li>按量付费</li>
</ul>
<p>预估费用在创建实例时可实时看到。</p>
<h2 id="_6">服务实例部署流程</h2>
<h3 id="_7">部署参数说明</h3>
<table>
<thead>
<tr>
<th>参数组</th>
<th>参数项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>服务实例</td>
<td>服务实例名称</td>
<td>长度不超过64个字符，必须以英文字母开头，可包含数字、英文字母、短划线（-）和下划线（_）。</td>
</tr>
<tr>
<td></td>
<td>地域</td>
<td>服务实例部署的地域。</td>
</tr>
<tr>
<td>ACS配置</td>
<td>可用区</td>
<td>ACS集群所在可用区。</td>
</tr>
<tr>
<td></td>
<td>专有网络VpcId</td>
<td>专有网络ID，不存在可新建。</td>
</tr>
<tr>
<td></td>
<td>交换机实例ID</td>
<td>交换机VSwitchId，对应专用网络（VPC）中的交换机，不存在可新建。。</td>
</tr>
<tr>
<td></td>
<td>Service CIDR</td>
<td>ACS集群中service可用网段，不能与 VPC 及 VPC 内已有 Kubernetes 集群使用的网段重复。</td>
</tr>
<tr>
<td>Wordpress配置</td>
<td>wordpress用户名</td>
<td>wordpress管理用户名，默认为user。</td>
</tr>
<tr>
<td></td>
<td>wordpress密码</td>
<td>wordpress管理密码，需进行设置</td>
</tr>
<tr>
<td>### 部署步骤</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ol>
<li>部署链接：
   <img alt="img.png" src="img.png" /></li>
<li>单击部署链接，进入服务实例部署界面，根据界面提示，填写参数完成部署。
   <img alt="img_2.png" src="img_2.png" /></li>
<li>参数填写完成后可以看到对应询价明细，确认参数后点击<strong>下一步：确认订单</strong>。
   <img alt="img_3.png" src="img_3.png" /></li>
<li>确认订单完成后同意服务协议并点击<strong>立即创建</strong>，随后进入部署阶段。
   <img alt="img_4.png" src="img_4.png" /></li>
<li>等待部署完成后就可以开始使用服务，进入服务实例详情点击visitUrl。
   <img alt="img_5.png" src="img_5.png" /></li>
<li>访问visitUrl可以进入blog的首页，访问visitUrl/admin可以进入blog的后台管理页面：
   <img alt="img_6.png" src="img_6.png" />
   <img alt="img_8.png" src="img_8.png" /></li>
</ol>
<h2 id="_8">服务详细说明</h2>
<p>本文通过将部署wordpress服务需要的service、deployment等yaml文件打包成helm压缩包, 上传到计算巢仓库生成helm部署物，在模版中创建ACS集群，将helm部署物部署到ACS集群上。</p>
<h3 id="_9">部署物</h3>
<p>helm部署物上传及关联配置在config.yaml中定义，Artifact_1为helm部署物定义，在DeployMetadata中定义了模版占位符{{ computenest::helmchart::wordpress }}与部署物的关联关系。</p>
<pre><code>Service:
  DeployMetadata:
    SupplierDeployMetadata:
      HelmChartArtifactRelation:
        '{{ computenest::helmchart::wordpress }}':
          ArtifactId: ${Artifact.Artifact_1.ArtifactId}
          ArtifactVersion: ${Artifact.Artifact_1.ArtifactVersion}
Artifact:
  Artifact_1:
    ArtifactType: HelmChart
    ArtifactName: wordpress
    Description: wordpress HelmChart部署物
    ArtifactProperty:
      RepoName: ${HelmChartBuilder.HelmChart_1.RepoName}
      Tag: ${HelmChartBuilder.HelmChart_1.Tag}
HelmChartBuilder:
  HelmChart_1:
    HelmChartPath: 'resources/artifact_resources/helm_chart/wordpress-15.4.1.tgz'
    RepoName: wordpress
    Tag: 15.4.1
</code></pre>
<h3 id="_10">模版文件</h3>
<p>ros_templates/template.yaml主要由三部分组成:</p>
<p>1.Parameters定义需要用户填写的参数，包括可用区、Acs集群配置、wordpress配置等参数。</p>
<pre><code>Parameters:
  ZoneId:
    AssociationProperty: ZoneId
    Required: true
    Type: String
    Description:
      en: The zone ID.
      zh-cn: 可用区
  VpcId:
    AssociationProperty: ALIYUN::ECS::VPC::VPCId
    Type: String
    Description:
      en: VPC ID.
      zh-cn: VpcId
  VSwitchId:
    Type: String
    Label:
      en: VSwitch ID
      zh-cn: 交换机实例ID
    Description:
      en: Instance ID of existing business network switches, console-Virtual Private Cloud-VSwitches under query
      zh-cn: 现有业务网络交换机的实例ID
    AssociationProperty: ALIYUN::ECS::VSwitch::VSwitchId
    AssociationPropertyMetadata:
      VpcId: ${VpcId}
      ZoneId: ${ZoneId}
  ServiceCidr:
    Type: String
    Description:
      zh-cn: 可选范围：10.0.0.0/16-24，172.16-31.0.0/16-24，192.168.0.0/16-24&lt;br&gt;不能与 VPC 及 VPC 内已有 Kubernetes 集群使用的网段重复。&lt;font color='blue'&gt;&lt;b&gt;创建成功后不能修改&lt;/b&gt;&lt;/font&gt;
      en: 'Optional range: 10.0.0.0/16-24, 172.16-31.0.0/16-24, 192.168.0.0/16-24&lt;br&gt; cannot duplicate segments already used by existing Kubernetes clusters in VPC and VPC.&lt;font color=''blue''&gt;&lt;b&gt;Cannot be modified after successful creation&lt;/b&gt;&lt;/font&gt;'
    Label:
      zh-cn: Service CIDR
      en: Service CIDR
    AssociationProperty: ALIYUN::CS::ManagedKubernetesCluster::ServiceCidr
    Default: 172.16.0.0/16
  WordpressUsername:
    Type: String
    Label:
      zh-cn: wordpress账户
      en: wordpress username
    Default: user
  WordpressPassword:
    NoEcho: true
    Type: String
    Label:
      zh-cn: wordpress密码
      en: wordpress password
</code></pre>
<p>2.Resources定义需要开的资源，主要包括ACS集群和LoadBalancer资源。MODULE::ACS::ComputeNest::FluxOciHelmDeploy资源类型会将helm部署物部署到ACS集群中，其中{{ computenest::helmchart::wordpress }}是helm部署物占位符，会替换为对应的helm chart仓库地址。</p>
<pre><code>Resources:
  AcsCluster:
    Type: ALIYUN::ACS::Cluster
    Properties:
      Name:
        Ref: ALIYUN::StackName
      VpcId:
        Ref: VpcId
      ServiceCidr:
        Ref: ServiceCidr
      ClusterSpec: ack.pro.small
      SnatEntry: true
      VSwitchIds:
        - Ref: VSwitchId
      ZoneId:
        Ref: ZoneId
      PodVSwitchIds:
        - Ref: VSwitchId
      ServiceDiscoveryTypes:
        - CoreDNS
  WordpressComputenestHelmApplication:
    Type: MODULE::ACS::ComputeNest::FluxOciHelmDeploy
    Version: v1
    Properties:
      ClusterId:
        Ref: ClusterId
      HelmChartUrl: '{{ computenest::helmchart::wordpress }}'
      DockerConfigJson: '{{ computenest::helm::dockerconfigjson }}'
      ChartValues:
        image:
          registry: compute-nest-registry.cn-hangzhou.cr.aliyuncs.com
          repository: bestpractice/wordpress
          tag: 6.2.0
        mariadb:
          image:
            registry: compute-nest-registry.cn-hangzhou.cr.aliyuncs.com
            repository: bestpractice/mariadb
            tag: 10.6.12
          primary:
            persistence:
              enabled: true
              storageClass: alicloud-disk-topology-alltype
              size: 20Gi
        persistence:
          enabled: false
        wordpressUsername:
          Ref: WordpressUsername
        wordpressPassword:
          Ref: WordpressPassword
      Namespace:
        Ref: 'ALIYUN::StackName'
      ReleaseName: wordpress
      WaitUntil:
        - Kind: Service
          Name: wordpress
          Namespace:
            Ref: ALIYUN::StackName
          JsonPath: $.status.loadBalancer.ingress[0].ip
          Operator: NotEmpty
          FirstMatch: true
          Timeout: 300
  # 获取service信息，输出到output中
  ClusterApplicationResources:
    Type: DATASOURCE::CS::ClusterApplicationResources
    DependsOn:
      - WordpressComputenestHelmApplication
    Properties:
      ClusterId:
        Ref: ClusterId
      Kind: Service
      Name: wordpress
      Namespace:
        Ref: ALIYUN::StackName
      JsonPath: $.status.loadBalancer.ingress[0].ip
      FirstMatch: true
</code></pre>
<p>3.Outputs定义需要最终在计算巢概览页中对用户展示的输出，展示wordpress的访问地址。</p>
<pre><code>Outputs:
  # 将公网ip做为http返回的地址显示在控制台
  BlogPageUrl:
    Description:
      zh-cn: Blog页面url
      en: Blog Page URL
    Value:
      Fn::Sub:
        - &quot;http://${ServerAddress}&quot;
        - ServerAddress:
            Fn::GetAtt:
              - ClusterApplicationResources
              - Response
  BlogAdminUrl:
    Description:
      zh-cn: Blog后台url
      en: Blog Admin URL
    Value:
      Fn::Sub:
        - &quot;http://${ServerAddress}/admin&quot;
        - ServerAddress:
            Fn::GetAtt:
              - ClusterApplicationResources
              - Response
</code></pre>
        
      </div>

      <div class="copyrights">© 2009-2022 Aliyun.com 版权所有</div>
    </div>
  </div>
  
  <!--
  MkDocs version      : 1.6.1
  Docs Build Date UTC : 2024-09-19 08:45:33.863110+00:00
  -->
</body>
</html>